### Телеграм-бот для подбора IP-видеокамер.

#### О боте

Бот написан на ```Python``` (3.12) с ```aiogram``` и рассчитан на работу через ```webhook с использованием serverless-технологий``` Яндекс Облака (Cloud Function, API Gateway, Message Queue, Managed Service for YDB). Для взаимодействия с базой данных используется ```SQLAlchemy```.

В текущей версии бота доступен только поиск по параметрам, которые нужно задать вручную.

Информация, которую предоставляет бот, несёт ознакомительный характер, точные характеристики или цену камеры следует уточнять у производителя (продавца).
Для удобства в ответе бота есть ссылки на поисковые запросы по модели камеры. Ссылки активны только для первых 50 моделей в ответе.

При выборе параметров следует учесть что:
- Если параметр отмечен знаком ❌, то этот параметр не учитывается при поиске.
- Параметр "Разрешение" подразумевает, что будут найдены камеры только с выбранным значением разрешения. Единица измерения: мегапиксель.
- Параметр "Чувствительность" подразумевает, что будут найдены камеры с таким или лучшим значением. Для видеокамер - чем меньше значение, тем лучше. Единица измерения: люкс.
- Параметр "ИК-подсветка" подразумевает, что будут найдены камеры с таким или лучшим (большим) значением дальности ИК-подсветки. Единица измерения: метр.
- Параметр "Минимальная рабочая температура" подразумевает, что будут найдены камеры с таким или лучшим (ниже) значением. Единица измерения: градус Цельсия.
- Параметр "Максимальная рабочая температура" подразумевает, что будут найдены камеры с таким или лучшим (выше) значением. Единица измерения: градус Цельсия.
- Параметр "Сетевой интерфейс" подразумевает, что будут найдены камеры, имеющие такой тип интерфейса.
- Параметр "Поддержка POE" подразумевает, что будут найдены камеры, поддерживающие POE.
- Параметр "Грозозащита" подразумевает, что будут найдены камеры, имеющие грозозащиту.
- Параметр "Комментарий" в текущей версии поддерживает поиск камер, имеющих Сертификат по Постановлению Правительства № 969.

#### Код

Папка ```src``` содержит код бота. Содержимое папки нужно упаковать в zip-архив, который далее использовать для загрузки кода в версию функции.

Или использовать готовый архив ```ip-cam-search-tg-bot-serverless.zip```

Настройки бота должны быть в файле ```.env```, который можно создать в "Редакторе" функции (после загрузки туда кода).
```
BOT_TOKEN=<токен_бота>
CLOUD_ID=<идентификатор_облака>
DB_ID=<идентификатор_базы_данных>
```
Не забыть про кнопку "Сохранить изменения".

#### База данных

В качестве базы данных используется "Managed Service for YDB" Яндекс Облака.

Папка ```db``` содержит:
- файл ```create-table.sql``` с примером запросов для создания таблиц ```cameras``` и ```users```,
- файл ```LTV_dataset.csv``` с примером датасета для загрузки в БД,
- файл ```LTV.ipynb``` с примерами обработки сырых данных для получения датасета.
В качестве сырых данных использовался csv-файл, экспортированный из экселевской таблички, загруженной с сайта производителя. 

#### Импорт данных из csv-файла в "Managed Service for YDB"

Используются CLI YDB и Cloud Shell, которая открыта в одном каталоге (фолдере) с базой. 

В Cloud Shell создать файл (например, ```vim cameras.csv```) и скопипастить туда содержимое файла ```LTV_dataset.csv```.

Первой строкой в файле должны идти названия колонок.

При необходимости заменить ```False``` на ```false```, а ```True``` на ```true```. Команды для Vim ```:%s/False/false/g``` ```:%s/True/true/g```

Импортировать данные из файла ```cameras.csv``` в таблицу ```cameras```. Для авторизации используются метаданные.

```bash
ydb \
    -e grpcs://ydb.serverless.yandexcloud.net:2135 \
    -d /ru-central1/<идентификатор_облака>/<идентификатор_базы_данных> \
    --use-metadata-credentials \
    import file csv -p cameras --header cameras.csv
```

#### Развёртывание бота в Яндекс Облаке

Примеры:

- (текст) [ToDo telegram bot](https://github.com/smallslowtank/todo-tg-bot-serverless?tab=readme-ov-file#%D1%80%D0%B0%D0%B7%D0%B2%D1%91%D1%80%D1%82%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B1%D0%BE%D1%82%D0%B0-%D1%80%D1%83%D0%BA%D0%B0%D0%BC%D0%B8-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-%D0%BA%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C-yandex-cloud)
- (видео) [Телеграм бот (aiogram, webhook, Yandex Cloud Function) бесплатно](https://www.youtube.com/watch?v=DzDXunnY6o8)

#### Webhook

Пример команды для подключения ```webhook``` находится в файле ```set-webhook.txt```. Обратить внимание на параметр ```url```.
```
curl \
  --request POST \
  --url https://api.telegram.org/bot<токен_бота>/setWebhook \
  --header 'content-type: application/json' \
  --data '{"url": "<домен_API-шлюза>/ip-cam-search-tg-bot"}'
```
Выполнить можно в Cloud Shell.
